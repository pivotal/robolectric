plugins {
    id "org.jetbrains.kotlin.jvm" version "1.3.70"
}

apply plugin: org.robolectric.gradle.RoboJavaModulePlugin
apply plugin: org.robolectric.gradle.DeployedRoboJavaModulePlugin

test {
    useJUnitPlatform {
        includeEngines 'spek'
    }
}

tasks['testClasses'].dependsOn(":testapp:assembleDebug")
tasks['testClasses'].dependsOn("provideTestConfig")

task provideTestConfig {
    doFirst {
        def appResFile = new File(project(":testapp").buildDir,
                // TODO(xian): something better than this:
                "intermediates/processed_res/debugAndroidTest/processDebugAndroidTestResources" +
                        "/out/resources-debugAndroidTest.ap_")
        println "project( = ${appResFile}"
        File outDir = project.sourceSets['test'].output.resourcesDir
        File outFile = new File(outDir, 'com/android/tools/test_config.properties')
        def props = new Properties()
        props.setProperty("android_resource_apk", appResFile.toString())

        File outParentDir = outFile.parentFile
        if (!outParentDir.directory) outParentDir.mkdirs()
        outFile.withPrintWriter { out ->
            props.store(out, "# GENERATED by ${this} -- do not edit")
        }
    }
}

dependencies {
    api project(":robolectric")
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.3.70"
    implementation "org.jetbrains.kotlin:kotlin-reflect:1.3.0"
    implementation "org.spekframework.spek2:spek-runtime-jvm:2.0.9"

    testImplementation project(path: ':testapp', configuration: 'default')
    testRuntimeOnly "org.spekframework.spek2:spek-runner-junit5:2.0.9"
    testRuntimeOnly "org.spekframework.spek2:spek-runtime-jvm:2.0.9"
    testImplementation "org.spekframework.spek2:spek-dsl-jvm:2.0.9"
    testImplementation "com.google.truth:truth:1.0.1"
    testCompileOnly AndroidSdk.MAX_SDK.coordinates // compile against latest Android SDK
    testRuntime AndroidSdk.MAX_SDK.coordinates // run against whatever this JDK supports
    testImplementation "androidx.test:core:1.3.0-alpha04"
}